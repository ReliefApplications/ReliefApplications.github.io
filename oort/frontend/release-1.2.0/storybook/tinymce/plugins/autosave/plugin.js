!function(){"use strict";var t,global$4=tinymce.util.Tools.resolve("tinymce.PluginManager"),isUndefined=(t=void 0,function(a){return t===a}),global$3=tinymce.util.Tools.resolve("tinymce.util.Delay"),global$2=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),global$1=tinymce.util.Tools.resolve("tinymce.util.Tools"),parse=function(timeString,defaultTime){var toParse=timeString||defaultTime,parsedTime=/^(\d+)([ms]?)$/.exec(""+toParse);return(parsedTime[2]?{s:1e3,m:6e4}[parsedTime[2]]:1)*parseInt(toParse,10)},getAutoSavePrefix=function(editor){var location=document.location;return editor.getParam("autosave_prefix","tinymce-autosave-{path}{query}{hash}-{id}-").replace(/{path}/g,location.pathname).replace(/{query}/g,location.search).replace(/{hash}/g,location.hash).replace(/{id}/g,editor.id)},isEmpty=function(editor,html){if(isUndefined(html))return editor.dom.isEmpty(editor.getBody());var trimmedHtml=global$1.trim(html);if(""===trimmedHtml)return!0;var fragment=(new DOMParser).parseFromString(trimmedHtml,"text/html");return editor.dom.isEmpty(fragment)},hasDraft=function(editor){var time=parseInt(global$2.getItem(getAutoSavePrefix(editor)+"time"),10)||0;return!((new Date).getTime()-time>function(editor){return parse(editor.getParam("autosave_retention"),"20m")}(editor))||(removeDraft(editor,!1),!1)},removeDraft=function(editor,fire){var prefix=getAutoSavePrefix(editor);global$2.removeItem(prefix+"draft"),global$2.removeItem(prefix+"time"),!1!==fire&&function(editor){editor.fire("RemoveDraft")}(editor)},storeDraft=function(editor){var prefix=getAutoSavePrefix(editor);!isEmpty(editor)&&editor.isDirty()&&(global$2.setItem(prefix+"draft",editor.getContent({format:"raw",no_events:!0})),global$2.setItem(prefix+"time",(new Date).getTime().toString()),function(editor){editor.fire("StoreDraft")}(editor))},restoreDraft=function(editor){var prefix=getAutoSavePrefix(editor);hasDraft(editor)&&(editor.setContent(global$2.getItem(prefix+"draft"),{format:"raw"}),function(editor){editor.fire("RestoreDraft")}(editor))},startStoreDraft=function(editor){var interval=function(editor){return parse(editor.getParam("autosave_interval"),"30s")}(editor);global$3.setEditorInterval(editor,(function(){storeDraft(editor)}),interval)},restoreLastDraft=function(editor){editor.undoManager.transact((function(){restoreDraft(editor),removeDraft(editor)})),editor.focus()},global=tinymce.util.Tools.resolve("tinymce.EditorManager"),makeSetupHandler=function(editor){return function(api){api.setDisabled(!hasDraft(editor));var editorEventCallback=function(){return api.setDisabled(!hasDraft(editor))};return editor.on("StoreDraft RestoreDraft RemoveDraft",editorEventCallback),function(){return editor.off("StoreDraft RestoreDraft RemoveDraft",editorEventCallback)}}};!function Plugin(){global$4.add("autosave",(function(editor){return function(editor){editor.editorManager.on("BeforeUnload",(function(e){var msg;global$1.each(global.get(),(function(editor){editor.plugins.autosave&&editor.plugins.autosave.storeDraft(),!msg&&editor.isDirty()&&function(editor){return editor.getParam("autosave_ask_before_unload",!0)}(editor)&&(msg=editor.translate("You have unsaved changes are you sure you want to navigate away?"))})),msg&&(e.preventDefault(),e.returnValue=msg)}))}(editor),function(editor){startStoreDraft(editor),editor.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:function(){restoreLastDraft(editor)},onSetup:makeSetupHandler(editor)}),editor.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:function(){restoreLastDraft(editor)},onSetup:makeSetupHandler(editor)})}(editor),editor.on("init",(function(){(function(editor){return editor.getParam("autosave_restore_when_empty",!1)})(editor)&&editor.dom.isEmpty(editor.getBody())&&restoreDraft(editor)})),function(editor){return{hasDraft:function(){return hasDraft(editor)},storeDraft:function(){return storeDraft(editor)},restoreDraft:function(){return restoreDraft(editor)},removeDraft:function(fire){return removeDraft(editor,fire)},isEmpty:function(html){return isEmpty(editor,html)}}}(editor)}))}()}();