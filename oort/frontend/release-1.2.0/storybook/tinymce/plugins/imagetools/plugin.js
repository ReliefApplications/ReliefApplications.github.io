!function(){"use strict";var type,call,id,Cell=function(initial){var value=initial;return{get:function(){return value},set:function(v){value=v}}},global$5=tinymce.util.Tools.resolve("tinymce.PluginManager"),global$4=tinymce.util.Tools.resolve("tinymce.util.Tools"),isArray=(type="array",function(value){return t=typeof(x=value),(null===x?"null":"object"===t&&(Array.prototype.isPrototypeOf(x)||x.constructor&&"Array"===x.constructor.name)?"array":"object"===t&&(String.prototype.isPrototypeOf(x)||x.constructor&&"String"===x.constructor.name)?"string":t)===type;var x,t}),isNonNullable=function(a){return!function(a){return null==a}(a)},isFunction=function(type){return function(value){return typeof value===type}}("function"),noop=function(){},constant=function(value){return function(){return value}},identity=function(x){return x},never=constant(!1),always=constant(!0),none=function(){return NONE},NONE={fold:function(n,_s){return n()},isSome:never,isNone:always,getOr:id=identity,getOrThunk:call=function(thunk){return thunk()},getOrDie:function(msg){throw new Error(msg||"error: getOrDie called on none.")},getOrNull:constant(null),getOrUndefined:constant(void 0),or:id,orThunk:call,map:none,each:noop,bind:none,exists:never,forall:always,filter:function(){return none()},toArray:function(){return[]},toString:constant("none()")},some=function(a){var constant_a=constant(a),self=function(){return me},bind=function(f){return f(a)},me={fold:function(n,s){return s(a)},isSome:always,isNone:never,getOr:constant_a,getOrThunk:constant_a,getOrDie:constant_a,getOrNull:constant_a,getOrUndefined:constant_a,or:self,orThunk:self,map:function(f){return some(f(a))},each:function(f){f(a)},bind,exists:bind,forall:bind,filter:function(f){return f(a)?me:NONE},toArray:function(){return[a]},toString:function(){return"some("+a+")"}};return me},Optional={some,none,from:function(value){return null==value?NONE:some(value)}},exports$1={},module={exports:exports$1};!function(define,exports,module,require){!function(global,factory){"object"==typeof exports&&void 0!==module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global="undefined"!=typeof globalThis?globalThis:global||self).EphoxContactWrapper=factory()}(this,(function(){var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},promise={exports:{}};!function(module){!function(root){var setTimeoutFunc=setTimeout;function noop(){}function Promise(fn){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof fn)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],doResolve(fn,this)}function handle(self,deferred){for(;3===self._state;)self=self._value;0!==self._state?(self._handled=!0,Promise._immediateFn((function(){var cb=1===self._state?deferred.onFulfilled:deferred.onRejected;if(null!==cb){var ret;try{ret=cb(self._value)}catch(e){return void reject(deferred.promise,e)}resolve(deferred.promise,ret)}else(1===self._state?resolve:reject)(deferred.promise,self._value)}))):self._deferreds.push(deferred)}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&("object"==typeof newValue||"function"==typeof newValue)){var then=newValue.then;if(newValue instanceof Promise)return self._state=3,self._value=newValue,void finale(self);if("function"==typeof then)return void doResolve(function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}(then,newValue),self)}self._state=1,self._value=newValue,finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2,self._value=newValue,finale(self)}function finale(self){2===self._state&&0===self._deferreds.length&&Promise._immediateFn((function(){self._handled||Promise._unhandledRejectionFn(self._value)}));for(var i=0,len=self._deferreds.length;i<len;i++)handle(self,self._deferreds[i]);self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.promise=promise}function doResolve(fn,self){var done=!1;try{fn((function(value){done||(done=!0,resolve(self,value))}),(function(reason){done||(done=!0,reject(self,reason))}))}catch(ex){if(done)return;done=!0,reject(self,ex)}}Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);return handle(this,new Handler(onFulfilled,onRejected,prom)),prom},Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise((function(resolve,reject){if(0===args.length)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&("object"==typeof val||"function"==typeof val)){var then=val.then;if("function"==typeof then)return void then.call(val,(function(val){res(i,val)}),reject)}args[i]=val,0==--remaining&&resolve(args)}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++)res(i,args[i])}))},Promise.resolve=function(value){return value&&"object"==typeof value&&value.constructor===Promise?value:new Promise((function(resolve){resolve(value)}))},Promise.reject=function(value){return new Promise((function(resolve,reject){reject(value)}))},Promise.race=function(values){return new Promise((function(resolve,reject){for(var i=0,len=values.length;i<len;i++)values[i].then(resolve,reject)}))},Promise._immediateFn="function"==typeof setImmediate?function(fn){setImmediate(fn)}:function(fn){setTimeoutFunc(fn,0)},Promise._unhandledRejectionFn=function _unhandledRejectionFn(err){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",err)},Promise._setImmediateFn=function _setImmediateFn(fn){Promise._immediateFn=fn},Promise._setUnhandledRejectionFn=function _setUnhandledRejectionFn(fn){Promise._unhandledRejectionFn=fn},module.exports?module.exports=Promise:root.Promise||(root.Promise=Promise)}(commonjsGlobal)}(promise);var promisePolyfill=promise.exports;return{boltExport:("undefined"!=typeof window?window:Function("return this;")()).Promise||promisePolyfill}}))}(void 0,exports$1,module);var Promise$1=module.exports.boltExport,create$1=function(width,height){return resize(document.createElement("canvas"),width,height)},clone=function(canvas){var tCanvas=create$1(canvas.width,canvas.height);return get2dContext(tCanvas).drawImage(canvas,0,0),tCanvas},get2dContext=function(canvas){return canvas.getContext("2d")},resize=function(canvas,width,height){return canvas.width=width,canvas.height=height,canvas},blobToImage$1=function(blob){return new Promise$1((function(resolve,reject){var blobUrl=URL.createObjectURL(blob),image=new Image,removeListeners=function(){image.removeEventListener("load",loaded),image.removeEventListener("error",error)},loaded=function(){removeListeners(),resolve(image)},error=function(){removeListeners(),reject("Unable to load data of type "+blob.type+": "+blobUrl)};image.addEventListener("load",loaded),image.addEventListener("error",error),image.src=blobUrl,image.complete&&setTimeout(loaded,0)}))},anyUriToBlob=function(url){return new Promise$1((function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.responseType="blob",xhr.onload=function(){200===this.status&&resolve(this.response)},xhr.onerror=function(){var obj,_this=this;reject(0===this.status?((obj=new Error("No access to download image")).code=18,obj.name="SecurityError",obj):new Error("Error "+_this.status+" downloading image"))},xhr.send()}))},dataUriToBlob=function(uri){return new Promise$1((function(resolve,reject){(function(uri){var data=uri.split(","),matches=/data:([^;]+)/.exec(data[0]);if(!matches)return Optional.none();for(var mimetype=matches[1],base64=data[1],byteCharacters=atob(base64),bytesLength=byteCharacters.length,slicesCount=Math.ceil(bytesLength/1024),byteArrays=new Array(slicesCount),sliceIndex=0;sliceIndex<slicesCount;++sliceIndex){for(var begin=1024*sliceIndex,end=Math.min(begin+1024,bytesLength),bytes=new Array(end-begin),offset=begin,i=0;offset<end;++i,++offset)bytes[i]=byteCharacters[offset].charCodeAt(0);byteArrays[sliceIndex]=new Uint8Array(bytes)}return Optional.some(new Blob(byteArrays,{type:mimetype}))})(uri).fold((function(){reject("uri is not base64: "+uri)}),resolve)}))},canvasToBlob=function(canvas,type,quality){return type=type||"image/png",isFunction(HTMLCanvasElement.prototype.toBlob)?new Promise$1((function(resolve,reject){canvas.toBlob((function(blob){blob?resolve(blob):reject()}),type,quality)})):dataUriToBlob(canvas.toDataURL(type,quality))},revokeImageUrl=function(image){URL.revokeObjectURL(image.src)},imageToBlob$1=function(image){return function(image){var src=image.src;return 0===src.indexOf("data:")?dataUriToBlob(src):anyUriToBlob(src)}(image)},nativeIndexOf=Array.prototype.indexOf,contains=function(xs,x){return ts=xs,t=x,nativeIndexOf.call(ts,t)>-1;var ts,t},each$1=function(xs,f){for(var i=0,len=xs.length;i<len;i++){f(xs[i],i)}},find=function(xs,pred){return function(xs,pred,until){for(var i=0,len=xs.length;i<len;i++){var x=xs[i];if(pred(x,i))return Optional.some(x);if(until(x,i))break}return Optional.none()}(xs,pred,never)},forall=function(xs,pred){for(var i=0,len=xs.length;i<len;++i){if(!0!==pred(xs[i],i))return!1}return!0},keys=Object.keys,Adt_generate=function(cases){if(!isArray(cases))throw new Error("cases must be an array");if(0===cases.length)throw new Error("there must be at least one case");var constructors=[],adt={};return each$1(cases,(function(acase,count){var keys$1=keys(acase);if(1!==keys$1.length)throw new Error("one and only one name per case");var key=keys$1[0],value=acase[key];if(void 0!==adt[key])throw new Error("duplicate key detected:"+key);if("cata"===key)throw new Error("cannot have a case named cata (sorry)");if(!isArray(value))throw new Error("case arguments must be an array");constructors.push(key),adt[key]=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var argLength=args.length;if(argLength!==value.length)throw new Error("Wrong number of arguments to case "+key+". Expected "+value.length+" ("+value+"), got "+argLength);var match=function(branches){var branchKeys=keys(branches);if(constructors.length!==branchKeys.length)throw new Error("Wrong number of arguments to match. Expected: "+constructors.join(",")+"\nActual: "+branchKeys.join(","));if(!forall(constructors,(function(reqKey){return contains(branchKeys,reqKey)})))throw new Error("Not all branches were specified when using match. Specified: "+branchKeys.join(", ")+"\nRequired: "+constructors.join(", "));return branches[key].apply(null,args)};return{fold:function(){for(var foldArgs=[],_i=0;_i<arguments.length;_i++)foldArgs[_i]=arguments[_i];if(foldArgs.length!==cases.length)throw new Error("Wrong number of arguments to fold. Expected "+cases.length+", got "+foldArgs.length);var target=foldArgs[count];return target.apply(null,args)},match,log:function(label){console.log(label,{constructors,constructor:key,params:args})}}}})),adt};Adt_generate([{bothErrors:["error1","error2"]},{firstError:["error1","value2"]},{secondError:["value1","error2"]},{bothValues:["value1","value2"]}]);var create=function(getCanvas,blob,uri){var initialType=blob.type,getType=constant(initialType),toDataURL=constant(uri),toAdjustedDataURL=function(type,quality){return getCanvas.then((function(canvas){return function(canvas,type,quality){return type=type||"image/png",canvas.toDataURL(type,quality)}(canvas,type,quality)}))};return{getType,toBlob:function(){return Promise$1.resolve(blob)},toDataURL,toBase64:function(){return uri.split(",")[1]},toAdjustedBlob:function(type,quality){return getCanvas.then((function(canvas){return canvasToBlob(canvas,type,quality)}))},toAdjustedDataURL,toAdjustedBase64:function(type,quality){return toAdjustedDataURL(type,quality).then((function(dataurl){return dataurl.split(",")[1]}))},toCanvas:function(){return getCanvas.then(clone)}}},fromBlob=function(blob){return function(blob){return new Promise$1((function(resolve){var reader=new FileReader;reader.onloadend=function(){resolve(reader.result)},reader.readAsDataURL(blob)}))}(blob).then((function(uri){return create(function(blob){return blobToImage$1(blob).then((function(image){revokeImageUrl(image);var canvas=create$1(function(image){return image.naturalWidth||image.width}(image),function(image){return image.naturalHeight||image.height}(image));return get2dContext(canvas).drawImage(image,0,0),canvas}))}(blob),blob,uri)}))},fromCanvas=function(canvas,type){return canvasToBlob(canvas,type).then((function(blob){return create(Promise$1.resolve(canvas),blob,canvas.toDataURL())}))},ceilWithPrecision=function(num,precision){void 0===precision&&(precision=2);var mul=Math.pow(10,precision),upper=Math.round(num*mul);return Math.ceil(upper/mul)},applyRotate=function(image,type,angle){var rad=(angle<0?360+angle:angle)*Math.PI/180,width=image.width,height=image.height,sin=Math.sin(rad),cos=Math.cos(rad),newWidth=ceilWithPrecision(Math.abs(width*cos)+Math.abs(height*sin)),newHeight=ceilWithPrecision(Math.abs(width*sin)+Math.abs(height*cos)),canvas=create$1(newWidth,newHeight),context=get2dContext(canvas);return context.translate(newWidth/2,newHeight/2),context.rotate(rad),context.drawImage(image,-width/2,-height/2),fromCanvas(canvas,type)},applyFlip=function(image,type,axis){var canvas=create$1(image.width,image.height),context=get2dContext(canvas);return"v"===axis?(context.scale(1,-1),context.drawImage(image,0,-canvas.height)):(context.scale(-1,1),context.drawImage(image,-canvas.width,0)),fromCanvas(canvas,type)},flip$1=function(ir,axis){return function(ir,axis){return ir.toCanvas().then((function(canvas){return applyFlip(canvas,ir.getType(),axis)}))}(ir,axis)},rotate$1=function(ir,angle){return function(ir,angle){return ir.toCanvas().then((function(canvas){return applyRotate(canvas,ir.getType(),angle)}))}(ir,angle)},sendRequest=function(url,headers,withCredentials){return void 0===withCredentials&&(withCredentials=!1),new Promise$1((function(resolve){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){4===xhr.readyState&&resolve({status:xhr.status,blob:xhr.response})},xhr.open("GET",url,!0),xhr.withCredentials=withCredentials,function(obj,f){for(var props=keys(obj),k=0,len=props.length;k<len;k++){var i=props[k];f(obj[i],i)}}(headers,(function(value,key){xhr.setRequestHeader(key,value)})),xhr.responseType="blob",xhr.send()}))},friendlyHttpErrors=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],friendlyServiceErrors=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],traverseJson=function(json,path){var f,acc,value=(f=function(result,key){return isNonNullable(result)?result[key]:void 0},acc=json,each$1(path,(function(x,i){acc=f(acc,x,i)})),acc);return Optional.from(value)},handleHttpError=function(status){var message=function(status){return"ImageProxy HTTP error: "+find(friendlyHttpErrors,(function(error){return status===error.code})).fold(constant("Unknown ImageProxy error"),(function(error){return error.message}))}(status);return Promise$1.reject(message)},getServiceErrorMsg=function(type){return find(friendlyServiceErrors,(function(error){return error.type===type})).fold(constant("Unknown service error"),(function(error){return error.message}))},getServiceError=function(text){var serviceError=function(text){try{return Optional.some(JSON.parse(text))}catch(ex){return Optional.none()}}(text);return"ImageProxy Service error: "+serviceError.bind((function(err){return traverseJson(err,["error","type"]).map(getServiceErrorMsg)})).getOr("Invalid JSON in service error message")},handleServiceError=function(blob){return function(blob){return new Promise$1((function(resolve,reject){var reader=new FileReader;reader.onload=function(){resolve(reader.result)},reader.onerror=function(e){reject(e)},reader.readAsText(blob)}))}(blob).then((function(text){var serviceError=getServiceError(text);return Promise$1.reject(serviceError)}))},isError=function(status){return status<200||status>=300},requestServiceBlob=function(url,apiKey){var headers={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":apiKey};return sendRequest(function(url,apiKey){var separator=-1===url.indexOf("?")?"?":"&";return/[?&]apiKey=/.test(url)?url:url+separator+"apiKey="+encodeURIComponent(apiKey)}(url,apiKey),headers).then((function(result){return isError(result.status)?(status=result.status,blob=result.blob,function(code,blob){return"application/json"===(null==blob?void 0:blob.type)&&(400===code||403===code||404===code||500===code)}(status,blob)?handleServiceError(blob):handleHttpError(status)):Promise$1.resolve(result.blob);var status,blob}))},getUrl=function(url,apiKey,withCredentials){return void 0===withCredentials&&(withCredentials=!1),apiKey?requestServiceBlob(url,apiKey):function(url,withCredentials){return sendRequest(url,{},withCredentials).then((function(result){return isError(result.status)?handleHttpError(result.status):Promise$1.resolve(result.blob)}))}(url,withCredentials)},blobToImageResult=function(blob){return fromBlob(blob)},fromDom=function(node){if(null==node)throw new Error("Node cannot be null or undefined");return{dom:node}},SugarElement={fromHtml:function(html,scope){var div=(scope||document).createElement("div");if(div.innerHTML=html,!div.hasChildNodes()||div.childNodes.length>1)throw console.error("HTML does not have a single root node",html),new Error("HTML must have a single root node");return fromDom(div.childNodes[0])},fromTag:function(tag,scope){var node=(scope||document).createElement(tag);return fromDom(node)},fromText:function(text,scope){var node=(scope||document).createTextNode(text);return fromDom(node)},fromDom,fromPoint:function(docElm,x,y){return Optional.from(docElm.dom.elementFromPoint(x,y)).map(fromDom)}};"undefined"!=typeof window?window:Function("return this;")();var child=function(scope,selector){return function(scope,predicate){return find(scope.dom.childNodes,(function(node){return predicate(SugarElement.fromDom(node))})).map(SugarElement.fromDom)}(scope,(function(e){return function(element,selector){var dom=element.dom;if(1!==dom.nodeType)return!1;var elem=dom;if(void 0!==elem.matches)return elem.matches(selector);if(void 0!==elem.msMatchesSelector)return elem.msMatchesSelector(selector);if(void 0!==elem.webkitMatchesSelector)return elem.webkitMatchesSelector(selector);if(void 0!==elem.mozMatchesSelector)return elem.mozMatchesSelector(selector);throw new Error("Browser lacks native selectors")}(e,selector)}))},global$3=tinymce.util.Tools.resolve("tinymce.util.Delay"),global$2=tinymce.util.Tools.resolve("tinymce.util.Promise"),global$1=tinymce.util.Tools.resolve("tinymce.util.URI"),getToolbarItems=function(editor){return editor.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions")},getProxyUrl=function(editor){return editor.getParam("imagetools_proxy")},getImageSize=function(img){var width,height,isPxValue=function(value){return/^[0-9\.]+px$/.test(value)};return width=img.style.width,height=img.style.height,width||height?isPxValue(width)&&isPxValue(height)?{w:parseInt(width,10),h:parseInt(height,10)}:null:(width=img.width,height=img.height,width&&height?{w:parseInt(width,10),h:parseInt(height,10)}:null)},getNaturalImageSize=function(img){return{w:img.naturalWidth,h:img.naturalHeight}},count=0,getFigureImg=function(elem){return child(SugarElement.fromDom(elem),"img")},isFigure=function(editor,elem){return editor.dom.is(elem,"figure")},isImage=function(editor,imgNode){return editor.dom.is(imgNode,"img:not([data-mce-object],[data-mce-placeholder])")},getEditableImage=function(editor,node){var isEditable=function(imgNode){return isImage(editor,imgNode)&&(isLocalImage(editor,imgNode)||isCorsImage(editor,imgNode)||isNonNullable(getProxyUrl(editor)))};return isFigure(editor,node)?getFigureImg(node).bind((function(img){return isEditable(img.dom)?Optional.some(img.dom):Optional.none()})):isEditable(node)?Optional.some(node):Optional.none()},displayError=function(editor,error){editor.notificationManager.open({text:error,type:"error"})},getSelectedImage=function(editor){var elem=editor.selection.getNode(),figureElm=editor.dom.getParent(elem,"figure.image");return null!==figureElm&&isFigure(editor,figureElm)?getFigureImg(figureElm):isImage(editor,elem)?Optional.some(SugarElement.fromDom(elem)):Optional.none()},extractFilename=function(editor,url,group){var m=url.match(/(?:\/|^)(([^\/\?]+)\.(?:[a-z0-9.]+))(?:\?|$)/i);return isNonNullable(m)?editor.dom.encode(m[group]):null},isLocalImage=function(editor,img){var url=img.src;return 0===url.indexOf("data:")||0===url.indexOf("blob:")||new global$1(url).host===editor.documentBaseURI.host},isCorsImage=function(editor,img){return-1!==global$4.inArray(function(editor){return editor.getParam("imagetools_cors_hosts",[],"string[]")}(editor),new global$1(img.src).host)},defaultFetchImage=function(editor,img){if(isCorsImage(editor,img))return getUrl(img.src,null,function(editor,img){return-1!==global$4.inArray(function(editor){return editor.getParam("imagetools_credentials_hosts",[],"string[]")}(editor),new global$1(img.src).host)}(editor,img));if(!isLocalImage(editor,img)){var proxyUrl=getProxyUrl(editor),src=proxyUrl+(-1===proxyUrl.indexOf("?")?"?":"&")+"url="+encodeURIComponent(img.src),apiKey=function(editor){return editor.getParam("api_key",editor.getParam("imagetools_api_key","","string"),"string")}(editor);return getUrl(src,apiKey,!1)}return imageToBlob$1(img)},imageToBlob=function(editor,img){return function(editor){return Optional.from(editor.getParam("imagetools_fetch_image",null,"function"))}(editor).fold((function(){return defaultFetchImage(editor,img)}),(function(customFetchImage){return customFetchImage(img)}))},findBlob=function(editor,img){var blobInfo=editor.editorUpload.blobCache.getByUri(img.src);return blobInfo?global$2.resolve(blobInfo.blob()):imageToBlob(editor,img)},cancelTimedUpload=function(imageUploadTimerState){global$3.clearTimeout(imageUploadTimerState.get())},updateSelectedImage=function(editor,origBlob,ir,uploadImmediately,imageUploadTimerState,selectedImage,size){return ir.toBlob().then((function(blob){var uri,name,filename,blobInfo,blobCache=editor.editorUpload.blobCache;uri=selectedImage.src;var useFilename=origBlob.type===blob.type;return function(editor){return editor.getParam("images_reuse_filename",!1,"boolean")}(editor)&&(blobInfo=blobCache.getByUri(uri),isNonNullable(blobInfo)?(uri=blobInfo.uri(),name=blobInfo.name(),filename=blobInfo.filename()):(name=extractFilename(editor,uri,2),filename=extractFilename(editor,uri,1))),blobInfo=blobCache.create({id:"imagetools"+count++,blob,base64:ir.toBase64(),uri,name,filename:useFilename?filename:void 0}),blobCache.add(blobInfo),editor.undoManager.transact((function(){var imageLoadedHandler=function(){editor.$(selectedImage).off("load",imageLoadedHandler),editor.nodeChanged(),uploadImmediately?editor.editorUpload.uploadImagesAuto():(cancelTimedUpload(imageUploadTimerState),function(editor,imageUploadTimerState){var imageUploadTimer=global$3.setEditorTimeout(editor,(function(){editor.editorUpload.uploadImagesAuto()}),function(editor){return editor.getParam("images_upload_timeout",3e4,"number")}(editor));imageUploadTimerState.set(imageUploadTimer)}(editor,imageUploadTimerState))};editor.$(selectedImage).on("load",imageLoadedHandler),size&&editor.$(selectedImage).attr({width:size.w,height:size.h}),editor.$(selectedImage).attr({src:blobInfo.blobUri()}).removeAttr("data-mce-src")})),blobInfo}))},selectedImageOperation=function(editor,imageUploadTimerState,fn,size){return function(){return getSelectedImage(editor).fold((function(){displayError(editor,"Could not find selected image")}),(function(img){return editor._scanForImages().then((function(){return findBlob(editor,img.dom)})).then((function(blob){return blobToImageResult(blob).then(fn).then((function(imageResult){return updateSelectedImage(editor,blob,imageResult,!1,imageUploadTimerState,img.dom,size)}))})).catch((function(error){displayError(editor,error)}))}))}},rotate=function(editor,imageUploadTimerState,angle){return function(){var flippedSize=getSelectedImage(editor).map((function(img){var size=getImageSize(img.dom);return size?{w:size.h,h:size.w}:null})).getOrNull();return selectedImageOperation(editor,imageUploadTimerState,(function(imageResult){return rotate$1(imageResult,angle)}),flippedSize)()}},flip=function(editor,imageUploadTimerState,axis){return function(){return selectedImageOperation(editor,imageUploadTimerState,(function(imageResult){return flip$1(imageResult,axis)}))()}},handleDialogBlob=function(editor,imageUploadTimerState,img,originalSize,blob){return function(blob){return blobToImage$1(blob)}(blob).then((function(newImage){var newSize=getNaturalImageSize(newImage);return originalSize.w===newSize.w&&originalSize.h===newSize.h||getImageSize(img)&&function(img,size){var width,height;size&&(width=img.style.width,height=img.style.height,(width||height)&&(img.style.width=size.w+"px",img.style.height=size.h+"px",img.removeAttribute("data-mce-style")),width=img.width,height=img.height,(width||height)&&(img.setAttribute("width",String(size.w)),img.setAttribute("height",String(size.h))))}(img,newSize),URL.revokeObjectURL(newImage.src),blob})).then(blobToImageResult).then((function(imageResult){return updateSelectedImage(editor,blob,imageResult,!0,imageUploadTimerState,img)}))},makeOpen=function(editor,imageUploadTimerState){return function(){var originalImgOpt=getSelectedImage(editor),originalSizeOpt=originalImgOpt.map((function(origImg){return getNaturalImageSize(origImg.dom)}));originalImgOpt.each((function(img){getEditableImage(editor,img.dom).each((function(_){findBlob(editor,img.dom).then((function(blob){var state=function(blob){return{blob,url:URL.createObjectURL(blob)}}(blob);editor.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:state}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(api){var blob=api.getData().imagetools.blob;originalImgOpt.each((function(originalImg){originalSizeOpt.each((function(originalSize){handleDialogBlob(editor,imageUploadTimerState,originalImg.dom,originalSize,blob)}))})),api.close()},onCancel:noop,onAction:function(api,details){switch(details.name){case"save-state":details.value?api.enable("save"):api.disable("save");break;case"disable":api.disable("save"),api.disable("cancel");break;case"enable":api.enable("cancel")}}})}))}))}))}};!function Plugin(){global$5.add("imagetools",(function(editor){var imageUploadTimerState=Cell(0),lastSelectedImageState=Cell(null);!function(editor,imageUploadTimerState){global$4.each({mceImageRotateLeft:rotate(editor,imageUploadTimerState,-90),mceImageRotateRight:rotate(editor,imageUploadTimerState,90),mceImageFlipVertical:flip(editor,imageUploadTimerState,"v"),mceImageFlipHorizontal:flip(editor,imageUploadTimerState,"h"),mceEditImage:makeOpen(editor,imageUploadTimerState)},(function(fn,cmd){editor.addCommand(cmd,fn)}))}(editor,imageUploadTimerState),function(editor){var changeHandlers=[],cmd=function(command){return function(){return editor.execCommand(command)}},isEditableImage=function(){return getSelectedImage(editor).exists((function(element){return getEditableImage(editor,element.dom).isSome()}))},onSetup=function(api){var handler=function(isEditableImage){return api.setDisabled(!isEditableImage)};return handler(isEditableImage()),changeHandlers=changeHandlers.concat([handler]),function(){changeHandlers=function(xs,pred){for(var r=[],i=0,len=xs.length;i<len;i++){var x=xs[i];pred(x,i)&&r.push(x)}return r}(changeHandlers,(function(h){return h!==handler}))}};editor.on("NodeChange",(function(){var isEditable=isEditableImage();each$1(changeHandlers,(function(handler){return handler(isEditable)}))})),editor.ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:cmd("mceImageRotateLeft"),onSetup}),editor.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:cmd("mceImageRotateRight"),onSetup}),editor.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:cmd("mceImageFlipVertical"),onSetup}),editor.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:cmd("mceImageFlipHorizontal"),onSetup}),editor.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:cmd("mceEditImage"),onSetup}),editor.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:cmd("mceImage")}),editor.ui.registry.addContextMenu("imagetools",{update:function(element){return getEditableImage(editor,element).map((function(_){return{text:"Edit image",icon:"edit-image",onAction:cmd("mceEditImage")}})).toArray()}})}(editor),function(editor){editor.ui.registry.addContextToolbar("imagetools",{items:getToolbarItems(editor),predicate:function(elem){return getEditableImage(editor,elem).isSome()},position:"node",scope:"node"})}(editor),function(editor,imageUploadTimerState,lastSelectedImageState){editor.on("NodeChange",(function(e){var lastSelectedImage=lastSelectedImageState.get(),selectedImage=getEditableImage(editor,e.element);lastSelectedImage&&!selectedImage.exists((function(img){return lastSelectedImage.src===img.src}))&&(cancelTimedUpload(imageUploadTimerState),editor.editorUpload.uploadImagesAuto(),lastSelectedImageState.set(null)),selectedImage.each(lastSelectedImageState.set)}))}(editor,imageUploadTimerState,lastSelectedImageState)}))}()}();