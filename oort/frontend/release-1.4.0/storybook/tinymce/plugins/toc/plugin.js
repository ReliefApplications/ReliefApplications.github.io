!function(){"use strict";var prefix,counter,global$3=tinymce.util.Tools.resolve("tinymce.PluginManager"),global$2=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),global$1=tinymce.util.Tools.resolve("tinymce.util.I18n"),global=tinymce.util.Tools.resolve("tinymce.util.Tools"),getTocClass=function(editor){return editor.getParam("toc_class","mce-toc")},getTocHeader=function(editor){var tagName=editor.getParam("toc_header","h2");return/^h[1-6]$/.test(tagName)?tagName:"h2"},tocId=(prefix="mcetoc_",counter=0,function(){var guid=(new Date).getTime().toString(32);return prefix+guid+(counter++).toString(32)}),readHeaders=function(editor){var tocClass=getTocClass(editor),headerTag=getTocHeader(editor),selector=function(depth){var i,selector=[];for(i=1;i<=depth;i++)selector.push("h"+i);return selector.join(",")}(function(editor){var depth=parseInt(editor.getParam("toc_depth","3"),10);return depth>=1&&depth<=9?depth:3}(editor)),headers=editor.$(selector);return headers.length&&/^h[1-9]$/i.test(headerTag)&&(headers=headers.filter((function(i,el){return!editor.dom.hasClass(el.parentNode,tocClass)}))),global.map(headers,(function(h){var id=h.id;return{id:id||tocId(),level:parseInt(h.nodeName.replace(/^H/i,""),10),title:editor.$.text(h),element:h}}))},generateTocContentHtml=function(editor){var tag,title,closeTag,html="",headers=readHeaders(editor),prevLevel=function(headers){for(var minLevel=9,i=0;i<headers.length;i++)if(headers[i].level<minLevel&&(minLevel=headers[i].level),1===minLevel)return minLevel;return minLevel}(headers)-1;if(!headers.length)return"";html+=(tag=getTocHeader(editor),title=global$1.translate("Table of Contents"),closeTag="</"+tag+">","<"+tag+' contenteditable="true">'+global$2.DOM.encode(title)+closeTag);for(var i=0;i<headers.length;i++){var h=headers[i];h.element.id=h.id;var nextLevel=headers[i+1]&&headers[i+1].level;if(prevLevel===h.level)html+="<li>";else for(var ii=prevLevel;ii<h.level;ii++)html+="<ul><li>";if(html+='<a href="#'+h.id+'">'+h.title+"</a>",nextLevel!==h.level&&nextLevel)for(ii=h.level;ii>nextLevel;ii--)html+=ii===nextLevel+1?"</li></ul><li>":"</li></ul>";else html+="</li>",nextLevel||(html+="</ul>");prevLevel=h.level}return html},insertToc=function(editor){var tocClass=getTocClass(editor),$tocElm=editor.$("."+tocClass);!function(editor,nodes){return!nodes.length||editor.dom.getParents(nodes[0],".mce-offscreen-selection").length>0}(editor,$tocElm)?updateToc(editor):editor.insertContent(function(editor){var html=generateTocContentHtml(editor);return'<div class="'+editor.dom.encode(getTocClass(editor))+'" contenteditable="false">'+html+"</div>"}(editor))},updateToc=function(editor){var tocClass=getTocClass(editor),$tocElm=editor.$("."+tocClass);$tocElm.length&&editor.undoManager.transact((function(){$tocElm.html(generateTocContentHtml(editor))}))},toggleState=function(editor){return function(api){var toggleDisabledState=function(){return api.setDisabled(editor.mode.isReadOnly()||!function(editor){return readHeaders(editor).length>0}(editor))};return toggleDisabledState(),editor.on("LoadContent SetContent change",toggleDisabledState),function(){return editor.on("LoadContent SetContent change",toggleDisabledState)}}},isToc=function(editor){return function(elm){return elm&&editor.dom.is(elm,"."+getTocClass(editor))&&editor.getBody().contains(elm)}};!function Plugin(){global$3.add("toc",(function(editor){!function(editor){editor.addCommand("mceInsertToc",(function(){insertToc(editor)})),editor.addCommand("mceUpdateToc",(function(){updateToc(editor)}))}(editor),function(editor){var insertTocAction=function(){return editor.execCommand("mceInsertToc")};editor.ui.registry.addButton("toc",{icon:"toc",tooltip:"Table of contents",onAction:insertTocAction,onSetup:toggleState(editor)}),editor.ui.registry.addButton("tocupdate",{icon:"reload",tooltip:"Update",onAction:function(){return editor.execCommand("mceUpdateToc")}}),editor.ui.registry.addMenuItem("toc",{icon:"toc",text:"Table of contents",onAction:insertTocAction,onSetup:toggleState(editor)}),editor.ui.registry.addContextToolbar("toc",{items:"tocupdate",predicate:isToc(editor),scope:"node",position:"node"})}(editor),function(editor){var $=editor.$,tocClass=getTocClass(editor);editor.on("PreProcess",(function(e){var $tocElm=$("."+tocClass,e.node);$tocElm.length&&($tocElm.removeAttr("contentEditable"),$tocElm.find("[contenteditable]").removeAttr("contentEditable"))})),editor.on("SetContent",(function(){var $tocElm=$("."+tocClass);$tocElm.length&&($tocElm.attr("contentEditable",!1),$tocElm.children(":first-child").attr("contentEditable",!0))}))}(editor)}))}()}();